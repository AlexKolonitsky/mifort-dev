# FTP
FTP (англ. File Transfer Protocol — протокол передачи файлов) — протокол, предназначенный для передачи файлов в компьютерных сетях. FTP позволяет подключаться к серверам FTP, просматривать содержимое каталогов и загружать файлы с сервера или на сервер; кроме того, возможен режим передачи файлов между серверами.
Протокол FTP относится к протоколам прикладного уровня и для передачи данных использует транспортный протокол TCP. Команды и данные, в отличие от большинства других протоколов передаются по разным портам. Порт 20 используется для передачи данных, порт  21 для передачи команд. В случае, если передача файла была прервана по каким-либо причинам, протокол предусматривает средства для докачки файла, что бывает очень удобно при передаче больших файлов.
Алгоритм работы протокола FTP
Работа FTP на пользовательском уровне содержит несколько этапов:
	1.	Идентификация (ввод имени-идентификатора и пароля).
	2.	Выбор каталога.
	3.	Определение режима обмена (поблочный, поточный, ASCII или двоичный).
	4.	Выполнение команд обмена (get, mget, dir, mdel, mput или put).
	5.	Завершение процедуры (quit или close).

telnet example.ru 21
Trying 192.168.0.1...
Connected to example.ru.
Escape character is '^]'.
220-Welcome to Pure-FTPd
You are user number 5 of 100 allowed.
Local time is now 17:41. Server port: 21.
220 You will be disconnected after 15 minutes of inactivity.
USER afiskon
331 User afiskon OK. Password required
PASS lamepassword
230-User afiskon has group access to:  coders
230 OK. Current restricted directory is /
FTP-сервер обычно работает на 21 порту. В приведенном примере строки, начинающиеся с цифр, посылаются сервером, остальные — клиентом. Запросы клиента всегда состоят из одной строки формата КОМАНДА [аргументы], в то время как ответы сервера могут содержать несколько строк.

Первая и последняя строки начинается с трех цифр, представляющих собой код ответа, за которыми идет текстовое описание ответа, отделенное от кода либо пробелом, либо тире. Если в качестве разделителя используется пробел, значит строка является последней в ответе (и, возможно, единственной), иначе — мы получили первую строку многострочного ответа. 

Как видно из примера, все начинается с посылки сервером кода 220. Затем пользователь должен залогиниться с помощью команд USER и PASS. Если все сделано правильно, на первую сервер ответит кодом 331, а на вторую — 230. Для анонимного входа (если он разрешен настройками сервера), в качестве имени пользователя следует указать «anonymous», а в качестве пароля — свой e-mail. На практике обычно посылается либо пустой e-mail, либо что-то типа root@example.ru.

Как видно, пароль передается в открытом виде, потому крайне желательно шифровать FTP-соединение с помощью SSL (это называется FTPS — FTP плюс SSL), а еще лучше — передавать файлы по SSH с помощью утилит scp, sftp или WinSCP. Первые две есть в любой unix-системе и используют для передачи файлов одноименные протоколы, работающие поверх SSH. WinSCP написан для Windows и внешне напоминает Total Commander, умеет работать как с устаревшим SCP (Secure Copy), так и SFTP (SSH File Transfer Protocol), появившимся только в SSH-2.

Особенность протокола FTP — для выполнения команд и передачи файлов используются разные соединения. Это в общем-то нормальное проектное решение. Мы же не знаем, что там в этих файлах записано, а если передавать их вместе с командами, придется как-то кодировать содержимое файла, чтобы отличить его от команд. 
При установлении нового соединения кто-то должен собственно соединяться, а кто-то соединение принимать. Если клиент открывает порт, а сервер коннектится к нему, режим передачи файла называется активным. В обратном случае — пассивным. За счет того, что многие пользователи Интернета сегодня сидят за NAT, обычно используется пассивный режим. И это не очень хорошо, потому что число портов у сервера ограничено.

# PASSIVE MODE

Изначально протокол предполагал встречное TCP-соединение от сервера к клиенту для передачи файла или содержимого каталога. Это делало невозможным общение с сервером, если клиент находится за IP NAT, кроме того, часто запрос соединения к клиенту блокируется файерволом. Чтобы этого избежать, было разработано расширение протокола FTP passive mode, когда соединение для передачи данных тоже происходит от клиента к серверу. Важным моментом является то, что клиент устанавливает соединение с адресом и портом, указанным сервером. Порт сервер выбирает случайным образом из определённого диапазона (49152-65534). Поэтому при нахождении ftp-сервера за NAT, следует явно указать в настройках сервера его адрес
NAT-PT.
Специально для работы FTP-протокола через межсетевые экраны было сделано расширение NAT, называемое NAT-PT (rfc2766), позволяющее транслировать входящие соединения от сервера к клиенту через NAT. В процессе такого соединения NAT подменяет передаваемые данные от клиента, указывая серверу истинный адрес и порт, с которым сможет соединиться сервер, а потом транслирует соединение от сервера от этого адреса клиенту на его адрес. Несмотря на все меры и нововведения, принятые для поддержки FTP-протокола, на практике функция NAT-PT обычно отключается во всех роутерах и маршрутизаторах с целью обеспечения дополнительной безопасности от вирусных угроз.
FTP-клиент
FTP-клиент — программа для упрощения доступа к FTP серверу. В зависимости от назначения может либо предоставлять пользователю простой доступ к удаленному FTP-серверу в режиме текстовой консоли, беря на себя только работу по пересылке команд пользователя и файлов, либо отображать файлы на удаленном сервере как если бы они являлись частью файловой системы компьютера  пользователя, либо и то и другое. В последних двух случаях FTP-клиент берет на себя задачу интерпретации действий пользователя в команды протокола FTP, тем самым давая возможность использовать протокол передачи файлов без ознакомления со всеми его премудростями.
Частными примерами использования FTP-клиента могут быть:
Публикация страниц сайта на интернет-сервере Веб-разработчиком
Cкачивание музыки, программ и любых других файлов данных обычным пользователем интернета. Данный пример зачастую даже не осознается многими пользователями как использование FTP-клиента и протокола, так как многие публичные сервера не запрашивают дополнительных данных для аутентификации пользователей, а Интернет-браузеры (также являющиеся FTP-клиентами) осуществляют скачивание файлов без дополнительных вопросов.
Примерами таких программ могут служить:
Интернет-браузеры (часто работают в режиме «только чтение», то есть не позволяют добавлять файлы на сервер)
Многие файловые менеджеры, например: Windows Explorer (Проводник), Total Commander, FAR, Midnight Commander, Krusader
Специализированные программы, например: FileZilla

#Процесс авторизации FTP

Процесс нешифрованной авторизации проходит в несколько этапов (символы \r\n означают перевод строки):
1. Установка TCP-соединения с сервером (обычно на 21 порт)
2. Посылка команды USER логин\r\n
3. Посылка команды PASS пароль\r\n
После успешной авторизации можно посылать на сервер другие команды.
Анонимный вход на FTP
Если к серверу разрешён анонимный доступ (как правило, лишь для загрузки данных с сервера), то в качестве логина используется ключевое слово «anonymous» или «ftp», а в качестве пароля — адрес электронной почты:
1. USER anonymous\r\n
2. PASS someone@email\r\n
Основные команды протокола
Существуют следующие команды :
ABOR — Прервать передачу файла
CDUP — Сменить директорию на вышестоящую.
CWD — Сменить директорию.
DELE — Удалить файл (DELE filename).
EPSV - Войти в расширенный пассивный режим. Применяется вместо PASV.
HELP — Выводит список команд принимаемых сервером.
LIST — Возвращает список файлов директории. Список передается через соединение данных (20 порт).
MDTM — Возвращает время модификации файла.
MKD — Создать директорию.
NLST — Возвращает список файлов директории в более кратком формате чем LIST. Список передается через соединение данных (20 порт).
NOOP — Пустая операция
PASV — Войти в пассивный режим. Сервер вернет адрес и порт к которому нужно подключиться чтобы забрать данные. Передача начнется при введении следующих команд RETR, LIST и тд. 
PORT — Войти в активный режим. Например PORT 12,34,45,56,78,89. В отличие от пассивного режима для передачи данных сервер сам подключается к клиенту. 
PWD — Возвращает текущую директорию. 
QUIT — Отключиться 
REIN — Реинициализировать подключение 
RETR — Скачать файл. Перед RETR должна быть команда PASV или PORT. 
RMD — Удалить директорию 
RNFR и RNTO — Переименовать файл. RNFR — что переименовывать, RNTO — во что. 
SIZE — Возвращает размер файла 
STOR — Закачать файл. Перед STOR должна быть команда PASV или PORT. 
SYST — Возвращает тип системы(UNIX, WIN, …) 
TYPE — Установить тип передачи файла(Бинарный, текстовый) 
USER — Имя пользователя для входа на сервер 
Права доступа и авторизация
Файловая система на удаленном сервере как правило имеет настройки прав доступа  для различных пользователей. Так, например, анонимным пользователям могут быть доступны лишь некоторые файлы, о существовании других пользователи знать не будут.
Другой группе пользователей могут быть доступны другие файлы или, например, в дополнение к правам на чтение файлов, могут быть также даны права на запись новых или обновление имеющихся файлов. Диапазон вариантов прав доступа зависит от операционной системы и программного обеспечения каждого конкретного FTP-сервера. Как правило, разделяют права на просмотр содержимого папки  (то есть возможность получить список содержащихся в ней файлов), на чтение файла(ов), на запись (создание, удаление, обновление) файла(ов)
Для авторизации  FTP-сервер, при подключении к нему FTP-клиента, запрашивает у последнего имя пользователя и пароль. Большинство FTP-клиентов в свою очередь запрашивают эти данные у пользователя в интерактивном режиме. Есть также и другой способ указать эти данные, включив их в URL FTP-сервера. Так, например, в строке
Коды ответов FTP
Существует пять групп ответов сервера:
Код	Значение
1xx	Команда принята и в настоящее время идет ее выполнение.
2xx	Команда принята и успешно выполнена.
3xx	Команда принята, требуется дополнительная команда.
4xx	Команда не может быть принята в данный момент.
5xx	Невозможно выполнить команду.

# Первая позиция
Единица означает, что команда принята к выполнению но ещё не завершена
Двойка означает, что выполнение команды успешно завершено
Тройка говорит о том, что команда принята и ожидается какая-либо дополнительная команда
Четверка говорит о том, что в данный момент команда выполнена быть не может
Пятерка означает принципиальную невозможность выполнения команды

Значение кода-отклика	Описание
1yz	Позитивный предварительный отклик, который означает, что операция начата. До завершения процедуры следует ожидать как минимум еще один отклик
2yz	Сигнал успешного завершения процедуры, говорящий о том, что можно ввести новую команду
3yz	Положительный промежуточный отклик, указывающий на то, что команда воспринята, но для продолжения требуется дополнительная информация
4yz	Негативный отклик, свидетельствующий о том, что команда не воспринята, но можно попробовать ее исполнить еще раз
5yz	Отклик, говорящий о том, что команда не выполнена и не может быть выполнена вообще

# Вторая позиция
Ноль соответствует синтаксической ошибке
Единица соответствует информационному сообщению
Двойка говорит о том, что сообщение относится либо к управляющему соединению, либо к соединению данных
Тройка соответствует сообщениям об аутентификации пользователя и его правах
Значение четверки не определено
Пятерка соответствует сообщению о состоянии файловой системы
Значение кода-отклика	Описание
x0z	Указывает на синтаксическую ошибку; синтаксис верен но команда не имеет смысла
x1z	Указание на необходимость ввода дополнительной информации
x2z	Отклик, связанный с управлением каналом связи
x3z	Отклик для команд идентификации пользователя и проверки пароля
x4z	Функция не определена
x5z	Отклик, характеризующий состояние файловой системы

Третья позиция
Третья цифра окончательно специфицирует ошибку.
Коды откликов

Код-отклик	Описание
110	Комментарий
120	Функция будет реализована через nnn минут
125	Канал открыт, обмен данными начат
150	Статус файла правилен, подготавливается открытие канала
200	Команда корректна
211	Системный статус или отклик на справочный запрос
212	Состояние каталога
213	Состояние файла
214	Справочное поясняющее сообщение
220	Слишком много подключений к FTP-серверу (можете попробовать позднее). В некоторых версиях указывает на успешное завершение промежуточной процедуры
221	Благополучное завершение по команде quit
225	Канал сформирован, но информационный обмен отсутствует
226	Закрытие канала, обмен завершен успешно
230	Пользователь идентифицирован, продолжайте
250	Запрос прошел успешно
331	Имя пользователя корректно, нужен пароль
332	Для входа в систему необходима аутентификация
421	Процедура не возможна, канал закрывается
425	Открытие информационного канала не возможно
426	Канал закрыт, обмен прерван
450	Запрошенная функция не реализована, файл не доступен, например, занят
451	Локальная ошибка, операция прервана
452	Ошибка при записи файла (не достаточно места)
500	Синтаксическая ошибка, команда не может быть интерпретирована (возможно она слишком длинна)
501	Синтаксическая ошибка (неверный параметр или аргумент)
502	Команда не используется (нелегальный тип MODE)
503	Неудачная последовательность команд
504	Команда не применима для такого параметра
530	Система не загружена (not logged in)
532	Необходима аутентификация для запоминания файла
550	Запрошенная функция не реализована, файл не доступен, например, не найден
552	Запрошенная операция прервана, недостаточно выделено памяти

