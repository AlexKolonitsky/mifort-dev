# DynamoDB

Amazon DynamoDB – это полностью управляемый сервис баз данных NoSQL, обеспечивающий прогнозируемую высокую производительность с эффективной масштабируемостью. При этом вы избавлены от необходимости администрирования таких моментов как: 
* ввод оборудования в эксплуатацию
* настройка и конфигурация оборудования
* репликация
* обновление ПО
* масштабирование кластеров

DynamoDB - хранилище данных типа "ключ-значение" (операции над данными происходят с помощью ключа) и "хранилище документов" (выполнение запросов в формате документов, например JSON, XML и HTML).

>DynamoDB, как представитель нерелляционной базы данных, не поддерживает  сложные запросы, основанные на принципе join, или комплексные транзакции.

Отличительная особенность данной базы данных - принцип оплаты, основанный на производительности (throughput), а не на объеме хранимой информации. Однако для эффективных запросов (чтения, записи) стоит оперировать объектами размером от 1 байта до 400 КБ. В случае "б*о*льших" объектов (например, неструктурированные BLOB-объекты)  можно использовать следующую связку сервисов: Amazon S3 - для хранения массивов информации, а DynamoDB - указатели на них.


## Настраиваемые сервисы DynamoDB

### FGAC - Функция полного контроля доступа
С ее помощью можно регулировать доступом как на уровне самой таблицы, так и ее отдельных атрибутов. Работает через токен безопасности. 
Не производится дополнительная оплата

### Непротиворечивость данных
Определяется временем, за которое результат успешно выполненной записи или обновления элемента данных отобразится при последующей операции чтения этого же элемента. 
* потенциально непротиворечивые данные - максимизирует пропускную способность чтения 

  >Как правило, данные становятся непротиворечивыми в течение одной секунды.

*  строго непротиворечивые данные - возвращает результат, в котором отражены все записи, получившие отклик об успешном выполнении перед совершением операции чтения
  
### Межрегиональная репликация 
Позволяет создавать и поддерживать реплики в одном или нескольких регионах AWS. Может использоваться для
1. Эффективного аварийного восстановления
2. Более быстрого чтения для пользователей в регионах отличных от того, где находится основной
3. Распределения нагрузок
4. Простой межрегиональной миграции и без остановки работы

  >За использование межрегиональной репликации дополнительная плата не взимается, оплата происходит только за ресурсы, используемые в процессе работы, по стандартным тарифам.  

### DynamoDB Streams

DynamoDB Streams - упорядоченная по времени последовательность изменений элементов в течение последних 24 часов. По истечении это времени данные удаляются. 

Включается отдельно для каждой таблицы. 

Изменения отображаются в порядке их применения относительно одних и тех же элементов. 

**Пример**

```
Был следующий порядок обновления:
	1. У игрока 1 - 100 очков
	2. У игрока 2 - 50 очков
	3. У игрока 1 - 70 очков
Третье обновление будет обязательно после первого. Но нет гарантий, что второе обновление будет строго между ними.
```
Считывать из потока можно со скоростью до двух раз превышающей выделенной пропускной способности записи в таблицу. 

В консоле можно настроить данные, которые будет содержать stream: данные, как о предшествующем, так и о новом значении элемента,  а также о типе изменения (INSERT, REMOVE или MODIFY) и о первичном ключе измененного элемента.

### Триггеры
Триггеры - это функция, которая позволяет выполнять пользовательские действия на основе обновлений элементов таблицы DynamoDB. Это работает следующим образом: 
* пользовательский код триггера DynamoDB хранится в функции AWS Lambda в виде кода
* связывается функция AWS Lambda с потоком DynamoDB Streams (для конкретной таблицы)
* AWS Lambda считывает обновления соответствующего потока и приводит код в действие. 

>Оплата - за фактическое время вычисления

### Время жизни TTL
Время жизни TTL - это механизм, с помощью которого можно настраивать удаление данных при достижении параметра "отметки времени" (атрибут формата POSIX - хранение времени в секундах от 1 января 1970г).

Например, используется для удаления журналов событий, история использования, данных о сессиях и др. 

Этот механизм работает по принципу наименьших затрат и старается не отвлекать ресурсы от других более важных задач. 

>Удаление происходит в течение 2 дней в фоновом режиме
 
### Пропускная способность

- пропускная способность чтения
- пропускная способность записи

##### Таблица расчетов пропускной способности
| Единица ресурса | Количество операций в секунду | Объем элементов|
| :---         |     :---:      |          ---: |
| Записи  | 1     | Не более 1КВ    |
| Чтения (строго непротиворечивого)    | 1      | Не более 4КВ |
| Чтения  (потенциально непротиворечивого)  | 2       | Не более 4КВ     |

##### Формула
```
Требуемое число единиц ресурса для выделения = число операций в секунду * Math.ceil(предполагаемый считываемый блок / объем элемента (табличный))
```
##### Пример

```
Так, если записываем блоки размерности меньше 1КВ и нужно выполнять 100 операций в секунду, то необходимое число ресурсов записи для выделения - 100. 
В случае если считываем 1.5 - уже 200 единиц ресурса надо выделить для обеспечения 100 операций в секунду. 200 = 100 * Math.ceil(1.5 / 1) = 100 * 2.
```

Наименьшая пропускная способность - 1 единица ресурса записи и 1 единица ресурса чтения. Увеличивать можно неограниченное количество за сутки, уменьшать - 4 раза.

>Требуемое количество единиц ресурса чтения определяется числом считываемых за секунду элементов, а не числом вызовов API. Например, считываем 500 элементов, тогда не важно сделано ли 500 отдельных вызовов по одному элементу, или 50 вызовов, каждый из которых вернет по 10 элементов.

### Глобальные и локальные индексы

Поскольку запросы формируются только с использованием первичного ключа (за исключением запроса scan), то для эффективных операций над таблицами стоит обратить внимание на такой гибкий механизм как индексы. Они позволяет делать запросы по атрибутам, которые не являются ключевыми.

Первичный ключ может быть:
 - partition key
 - partition and sort key.

Amazon DynamoDB поддерживает два типа индексов.

| Тип индекса| Partion key | Sort key | Количество| Поддерживаемые запросы|
| :---         |     :---      |         :--- |:---:|:---: |
| Локальный   | Совпадает с partion key таблицы   | Имеет иной sort key таблицы  |До 5 индексов|Scan|
| Глобальный     |Может отличаться от partion key таблицы  | Может отличаться от sort key таблицы  |До 5 индексов|Query and Scan|

Благодаря тому, что элементы появляются в индексе только тогда, когда они существуют в таблице (являются разреженными объектами по отношению к остальным элементам таблицы), для которой задан индекс, запросы, обращенные к индексу, имеют очень высокую **эффективность**.

Локальный индекс потребляет выделенные ресурсы как часть таблицы, с которой связан. Он позволяет отрабатывать запросы по элементам, имеющим одинаковое значение partion key, но различные sort key. 

Для глобальных можно настроить пропускную способностью независимо от таблицы, на которой они основаны, что позволяет перераспределить нагрузку таблицы. 

Индексировать можно такие типы как число, строка, бинарные данные. (Set, List и Map, не подлежат индексации).

## Как работать с DynamoDB

### Типы данных DynamoDb

|Наименование| Типы| Дополнительное описание|
|--|--|--|
|Scalar Types |String, Number, Binary, Boolean, Null |  |
|Document Types |List [ … ], Map { … } - до 32 уровеня вложенности |Одновременно может содержать различные типы|
|Set Types |String set, Number set, Binary set| Cодержит однотипные элементы|

### Начало работы для Node js

Примеры можно взять на сайте [Amazone](http://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.NodeJs.html).


### SDK
Для удобной работы с DynamoDB стоит обратить внимание не на sdk [AWS.DynamoDB](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html), а на [AWS.DynamoDB.DocumentClient](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB/DocumentClient.html). Что позволяет не использовать громоздкую структуру описания типов данных в коде. JavaScript объекты автоматически преобразуются в объекты Amazon DynamoDB и обратно.
